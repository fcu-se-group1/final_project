{% extends "base.html" %}

{% block title %}Article record{% endblock %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center" style="height: 80%;">
    <div class="col-12 col-md-10 col-lg-8 col-xl-6">
        <div class="card border-dark rounded-4 h-100">
            <div class="card-header d-flex justify-content-between p-3 px-4">
                <h3 class="fw-bold mb-0">發表過的文章</h3>
                <p id="courseCode" class="fw-bold mb-0 d-flex justify-content-center align-items-center text-dark px-1"></p>
            </div>
            <div class="card-body col-12 text-dark p-4 d-flex justify-content-center align-items-center" id="cardBody">
                <div class="col-12 vh-50 p-0 d-flex flex-column justify-content-start align-items-center overflow-auto" id="overflowContainer">
                    <div class="col-12" id="article_record"></div>
                </div>
                <p id="noRecordsMessage" class="text-secondary my-3 d-none">您尚未發表過文章</p>
            </div>
            <div class="card-footer px-4">
                <div class="d-flex justify-content-end" style="gap: 2rem;">
                    <a href="{{ url_for('social_personal_homepage') }}" class="btn btn-indigo">返回</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content1 %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userId = localStorage.getItem('user_id');
        if (userId) {
            fetchArticleRecords(userId);
        } else {
            alert('無法獲取用戶ID');
        }
    });

    async function fetchArticleRecords(userId) {
        try {
            const response = await fetch(`/user_articles/${userId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            if (response.ok) {
                displayArticleRecords(data);
            } else {
                alert(data.error || '無法獲取文章記錄');
            }
        } catch (error) {
            console.error('Error fetching article records:', error);
        }
    }

    function displayArticleRecords(data) {
        const articleRecordContainer = document.getElementById('article_record');
        const noRecordsMessage = document.getElementById('noRecordsMessage');

        if (data.message) {
            noRecordsMessage.classList.remove('d-none');
            return;
        }

        data.forEach(article => {
            const articleDiv = document.createElement('div');
            articleDiv.className = 'article-record mb-3';

            const titleLink = document.createElement('a');
            titleLink.href = '#';
            titleLink.textContent = article.title;
            titleLink.className = 'd-block mb-1';
            titleLink.addEventListener('click', function() {
                localStorage.setItem('article_id', article.article_id);
                window.location.href = '/article_content';
            });

            const editLink = document.createElement('a');
            editLink.href = `/edit_article?article_id=${article.article_id}`;
            editLink.textContent = '編輯';
            editLink.className = 'btn btn-sm btn-primary me-2';

            const deleteLink = document.createElement('a');
            deleteLink.href = '#';
            deleteLink.textContent = '刪除';
            deleteLink.className = 'btn btn-sm btn-danger';
            deleteLink.addEventListener('click', function() {
                deleteArticle(article.article_id);
            });

            articleDiv.appendChild(titleLink);
            articleDiv.appendChild(editLink);
            articleDiv.appendChild(deleteLink);
            articleRecordContainer.appendChild(articleDiv);
        });
    }

    async function deleteArticle(articleId) {
        if (confirm('確定要刪除這篇文章嗎？')) {
            try {
                const response = await fetch(`/user_articles/delete/${articleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.error || '無法刪除文章');
                }
            } catch (error) {
                console.error('Error deleting article:', error);
            }
        }
    }
</script>
{% endblock %}