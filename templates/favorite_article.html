{% extends "base.html" %}

{% block title %}Favorite Articles{% endblock %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center" style="height: 80%;">
    <div class="col-12 col-md-10 col-lg-8 col-xl-6">
        <div class="card border-dark rounded-4 h-100">
            <div class="card-header d-flex justify-content-between p-3 px-4">
                <h3 class="fw-bold mb-0">收藏的文章</h3>
                <p id="courseCode" class="fw-bold mb-0 d-flex justify-content-center align-items-center text-dark px-1"></p>
            </div>
            <div class="card-body col-12 text-dark p-4 d-flex justify-content-center align-items-center" id="cardBody">
                <div class="col-12 vh-50 p-0 d-flex flex-column justify-content-start align-items-center overflow-auto" id="overflowContainer">
                    <div class="col-12" id="favorite_articles"></div>
                </div>
                <p id="noFavoritesMessage" class="text-secondary my-3 d-none">您尚未收藏任何文章</p>
            </div>
            <div class="card-footer px-4">
                <div class="d-flex justify-content-end" style="gap: 2rem;">
                    <a href="{{ url_for('social_personal_homepage') }}" class="btn btn-indigo">返回</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content1 %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userId = localStorage.getItem('user_id');
        if (userId) {
            fetchFavoriteArticles(userId);
        } else {
            alert('無法獲取用戶ID');
        }
    });

    async function fetchFavoriteArticles(userId) {
        try {
            const response = await fetch(`/favorites/${userId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            if (response.ok) {
                displayFavoriteArticles(data);
            } else {
                alert(data.error || '無法獲取收藏的文章');
            }
        } catch (error) {
            console.error('Error fetching favorite articles:', error);
        }
    }

    function displayFavoriteArticles(data) {
        const favoriteArticlesContainer = document.getElementById('favorite_articles');
        const noFavoritesMessage = document.getElementById('noFavoritesMessage');

        if (data.message) {
            noFavoritesMessage.classList.remove('d-none');
            return;
        }

        data.forEach(article => {
            const articleDiv = document.createElement('div');
            articleDiv.className = 'favorite-article mb-3';

            const titleLink = document.createElement('a');
            titleLink.href = '#';
            titleLink.textContent = article.title;
            titleLink.className = 'd-block mb-1';
            titleLink.addEventListener('click', function() {
                checkArticleExists(article.article_id);
            });

            articleDiv.appendChild(titleLink);
            favoriteArticlesContainer.appendChild(articleDiv);
        });
    }

    async function checkArticleExists(articleId) {
        try {
            const response = await fetch(`/favorites/detail/${articleId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            if (response.ok && data.message === '存在') {
                localStorage.setItem('article_id', articleId);
                window.location.href = '/article_content';
            } else {
                alert(data.error || '該文章已被刪除');
            }
        } catch (error) {
            console.error('Error checking article existence:', error);
        }
    }
</script>
{% endblock %}